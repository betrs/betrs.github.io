





<!doctype html>
<html lang="">

<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script type="text/javascript" 
src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js">
</script>
<link href=  "/plugins/code-theme/tomorrow-night.css" type="text/css" rel="stylesheet" />
<link rel="stylesheet" href="/plugins/github-markdown.css">

<head>
  <meta charset="UTF-8">
  
    
    
      <link rel="stylesheet" href="/css/legend.css">
    
  
</head>

<body id="body-x">
<div id="layout-content">
  <div id="menu-outer-x">
  <div id="menu-inner">
    
    
    <div id="site-title">
      吴佳博客
    </div>
    

     
    <div>
    
      
      <a href="/">首页</a>
      
    
      
      <a href="/archives">归档</a>
      
    
    </div>
  </div>
</div> 
  <div id="content-outer">
    <div id="content-inner">
      
      
  <article class="markdown-body">
    <h1 id="post-title">js闭包详解
       
        <div id="post-time" datetime="2016-10-13T07:50:38.000Z">
          2016-10-13
        </div>
      
    </h1>
    <p>闭包有三个特性：<br><br>1.函数嵌套函数<br><br>2.函数内部可以引用外部的参数和变量<br><br>3.参数和变量不会被垃圾回收机制回收<br>闭包的定义及其优缺点</p>
<p>闭包 是指有权访问另一个函数作用域中的变量的函数，创建闭包的最常见的方式就是在一个函数内创建另一个函数，通过另一个函数访问这个函数的局部变量</p>
<p>使用闭包有一个优点，也是它的缺点，就是可以把局部变量驻留在内存中，可以避免使用全局变量。全局变量在每个模块都可调用，这势必将是灾难性的。（所以推荐使用私有的，封装的局部变量。）</p>
<a id="more"></a>
<p>一般函数执行完毕后，局部活动对象就被销毁，内存中仅仅保存全局作用域。但闭包的情况不同！</p>
<p>嵌套函数的闭包</p>
<pre><code>function aaa() {  
  var a = 1;  
  return function(){
   alert(a++)
  };  
}         
var fun = aaa();  
fun();// 1 执行后 a++，，然后a还在~  
fun();// 2   
fun = null;//a被回收！！
</code></pre><p>闭包会使变量始终保存在内存中，如果不当使用会增大内存消耗。</p>
<p>javascript的垃圾回收原理</p>
<p>（1）、在javascript中，如果一个对象不再被引用，那么这个对象就会被GC回收；<br><br>（2）、如果两个对象互相引用，而不再被第3者所引用，那么这两个互相引用的对象也会被回收。</p>
<p>使用闭包的好处</p>
<p>那么使用闭包有什么好处呢？使用闭包的好处是：</p>
<p>1.希望一个变量长期驻扎在内存中<br><br>2.避免全局变量的污染<br><br>3.私有成员的存在</p>
<p>#一、全局变量的累加</p>
<pre><code>var a = 1;
function abc(){
  a++;
  alert(a);
}
abc(); //2
abc(); //3
</code></pre><p>#二、局部变量</p>
<pre><code>function abc(){        
    var a = 1;
    a++;
    alert(a);
}
abc(); //2
abc(); //2
</code></pre><p>那么怎么才能做到变量a既是局部变量又可以累加呢？</p>
<p>#三、局部变量的累加</p>
<pre><code>function outer(){        
    var x=10;        
    return function(){ //函数嵌套函数
    x++;
    alert(x);
    }
}

var y = outer(); //外部函数赋给变量y;
y(); //y函数调用一次，结果为11，相当于outer()()；
y(); //y函数调用第二次，结果为12，实现了累加
</code></pre><p>函数声明与函数表达式</p>
<p>在js中我们可以通过关键字function来声明一个函数：</p>
<pre><code>function abc(){
    alert(123);
}
abc();
</code></pre><p>我们也可以通过一个”()”来将这个声明变成一个表达式：</p>
<pre><code>(function (){
    alert(123);
})(); //然后通过()直接调用前面的表达式即可，因此函数可以不必写名字；
</code></pre><p>#四、模块化代码，减少全局变量的污染</p>
<pre><code>var abc = (function(){ //abc为外部匿名函数的返回值
   var a = 1;        
   return function(){
    a++;
    alert(a);
   }
})();

abc(); //2  调用一次abc函数，其实是调用里面内部函数的返回值    
abc(); //3
</code></pre><p>#五、私有成员的存在</p>
<pre><code>var aaa = (function(){        
    var a = 1;        
    function bbb(){
    a++;
    alert(a);
    }        
   function ccc(){
        a++;
        alert(a);
    }        
   return {
    b:bbb,//json结构
    c:ccc
    }
})();

aaa.b();     //2
aaa.c();      //3
</code></pre><p>#六.使用匿名函数实现累加<br>使用匿名函数实现局部变量驻留内存中，从而实现累加</p>
<pre><code>function box(){     
     var age = 100;     
     return function(){   //匿名函数
      age++;          
      return age;
     };
};

var b = box();

alert(b());
alert(b());    //即alert(box()())；
alert(b());
alert(b); 

function () {
   age++;
   return age;
}
b = null；  //解除引用，等待垃圾回收
</code></pre><p>过度使用闭包会导致性能的下降。函数里放匿名函数，则产生了闭包</p>
<p>#七、在循环中直接找到对应元素的索引</p>
<pre><code>&lt;html&gt;
&lt;head&gt;
    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=UTF-8&quot; /&gt;
    &lt;title&gt;&lt;/title&gt;

    &lt;script&gt;         
         var aLi = document.getElementsByTagName(&apos;li&apos;);            
         for (var i=0;i&lt;aLi.length;i++){
            aLi[i].onclick = function(){        //当点击时for循环已经结束
                alert(i);
               };
        };
       &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
        &lt;ul&gt;
                &lt;li&gt;123&lt;/li&gt;
                &lt;li&gt;456&lt;/li&gt;
                &lt;li&gt;789&lt;/li&gt;
                &lt;li&gt;010&lt;/li&gt;
        &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>#八、使用闭包改写上面代码</p>
<pre><code>&lt;html&gt;
    &lt;head&gt;
        &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html;charset=UTF-8&quot; /&gt;
        &lt;title&gt;&lt;/title&gt;
        &lt;script&gt;        
        var aLi = document.getElementsByTagName(&apos;li&apos;);            
        for (var i=0;i&lt;aLi.length;i++){
                    (function(i){
                            aLi[i].onclick = function(){
                                    alert(i);
                            };
                    })(i);
            }
            };    
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;ul&gt;
        &lt;li&gt;123&lt;/li&gt;
        &lt;li&gt;456&lt;/li&gt;
        &lt;li&gt;789&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>#九.内存泄露问题</p>
<p>由于IE的js对象和DOM对象使用不同的垃圾收集方法，因此闭包在IE中会导致内存泄露问题，也就是无法销毁驻留在内存中的元素</p>
<pre><code>function closure(){    
    var oDiv = document.getElementById(&apos;oDiv&apos;);//oDiv用完之后一直驻留在内存中
    oDiv.onclick = function () {
       alert(&apos;oDiv.innerHTML&apos;);//这里用oDiv导致内存泄露
    };
}
closure();

//最后应将oDiv解除引用来避免内存泄露

function closure(){    
    var oDiv = document.getElementById(&apos;oDiv&apos;);    
    var test = oDiv.innerHTML;
    oDiv.onclick = function () {
    alert(test);
    };
    oDiv = null;
}
</code></pre><p>#十.思考题</p>
<p>如果你能理解下面代码的运行结果，应该就算理解闭包的运行机制了。</p>
<pre><code>var name = &quot;trigkit4&quot;;   
　　var segmentFault = {  
　　　　name : &quot;My SF&quot;,  
　　　　getNameFunc : function(){  
　　　　　　return function(){  
　　　　　　　　return this.name;  
　　　　　};   
　　　　}   
};  
//alert(segmentFault.getNameFunc()());  //弹出trigkit4
</code></pre>
  </article>

  
    
    
      <div id="page-prev-next">
        
        
          <a id="page-prev-a" href="/2016/10/14/touchEvent/"> ← 手机端html5触屏事件(touch事件) </a>
        

        
        
      </div>
    
    
    
    
      
      <div id="play-button"  style="background-color: #6d5aca; border: solid 2px #6d5aca;">
  <img id="play-img" src="/images/playback_play.png"></img>
</div>
<audio id="bgaudio" loop="loop" preload="none"> 
  <source src=http://cdn.calm.com/scenes/scene-Qqkzy9k7Eo.m4a?v=1418162240715 type="audio/mpeg">
</audio>

<script>
$(document).ready(function(){
  //播放按钮点击
  var audio = $("#bgaudio")[0];
  var img = $("#play-img")[0];
  $("#play-button").click(function(){ 
    if (audio.paused || audio.ended) {
      audio.play();
      img.src = "/images/playback_pause.png";
    } else {
      audio.pause();
      img.src = "/images/playback_play.png";
    }
  });
});
</script>
    

    
    

  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div id="reward_comment">文章对我有帮助，打赏作者</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.png" alt="吴佳 WeChat Pay"/>
          <p>微信</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/alipay.png" alt="吴佳 Alipay"/>
          <p>支付宝</p>
        </div> 
      
    </div>
  </div>


  

    </div>

    <!-- 多说评论框 -->    
    
      <div class="ds-thread" data-thread-key="2016/10/13/detailedClosure/" data-title="js闭包详解" data-url="http://yoursite.com/2016/10/13/detailedClosure/"></div>
    
  </div>
</div>

<div id="bottom-outer">
  
  <div id="bottom-inner">
    吴佳 
    ©2016 |Powered by  
    <a href="http://hexo.io" target="_blank">Hexo</a> with theme 
    <a href="https://github.com/iHongRen/legend" target="_blank">legend</a>
  </div>
    
    
    
      <a href="/atom.xml">
      
      <img src=/images/rss.png height="18" width="18">
      
</div> 


  
  
    <script src="/js/legend.js"></script>
  


</body>
</html>



  
<script type="text/javascript">
var duoshuoQuery = {short_name:"ihongren"};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
   || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>



<script>
$(window).on('load', function(){
   $('pre').addClass('prettyprint').attr('style', 'overflow:auto;');
   prettyPrint();
 });
</script>

